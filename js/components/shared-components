/**
 * VelocityQA Shared Components
 * This file initializes and manages shared UI components across all pages
 */

// Initialize all components when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize slide panels (like in Precision Strike page)
    initSlidePanels();
    
    // Initialize floating "Add Package" buttons
    initFloatingButtons();
    
    // Handle URL parameters for package selection
    handleUrlParameters();
    
    // Initialize prepaid hours selector
    initPrepaidHoursSelector();
    
    // Initialize service type radio buttons
    initServiceTypeRadios();
    
    // Initialize FAQ accordions
    initFaqAccordions();
    
    // Custom cursor initialization
    initCustomCursor();
});

/**
 * Initialize slide panels (used in Precision Strike page)
 */
function initSlidePanels() {
    const slidePanel = document.getElementById('slide-panel');
    const slideHandle = document.getElementById('slide-handle');
    const slideArrow = document.getElementById('slide-arrow');
    
    if (slidePanel && slideHandle && slideArrow) {
        console.log("Slide panel elements found, initializing panel...");
        let isPanelOpen = false;
        
        // Function to toggle panel state
        function togglePanel() {
            if (isPanelOpen) {
                slidePanel.style.transform = 'translateX(100%)';
                slideArrow.style.transform = 'rotate(0deg)';
            } else {
                slidePanel.style.transform = 'translateX(0)';
                slideArrow.style.transform = 'rotate(180deg)';
            }
            isPanelOpen = !isPanelOpen;
        }
        
        // Add click event to handle
        slideHandle.addEventListener('click', togglePanel);
        
        // Auto slide-in immediately after a very short delay
        setTimeout(function() {
            togglePanel(); // Slide in
            
            // Auto slide-out after 8 seconds
            setTimeout(function() {
                togglePanel(); // Slide out
                
                // Periodically slide in/out every 30 seconds
                setInterval(function() {
                    togglePanel(); // Slide in
                    
                    setTimeout(function() {
                        togglePanel(); // Slide out
                    }, 8000);
                }, 30000);
            }, 8000);
        }, 300); // Reduced delay for faster initial animation
    }
}

/**
 * Initialize floating "Add Package" buttons
 */
function initFloatingButtons() {
    const addPackageButton = document.getElementById('addPackageButton');
    
    if (addPackageButton) {
        // Fade in the button
        setTimeout(() => {
            addPackageButton.style.opacity = '1';
        }, 500);
        
        // Add notification when clicked
        addPackageButton.addEventListener('click', function(e) {
            // Get package name from href
            const href = this.getAttribute('href');
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const packageType = urlParams.get('package');
            const packageName = getReadablePackageName(packageType);
            
            // Create notification element
            showNotification(`${packageName} added to your selections`);
        });
    }
    
    // Initialize all add-package links
    const addPackageLinks = document.querySelectorAll('a[href*="package="][href*="add=true"]');
    addPackageLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const packageType = urlParams.get('package');
            const packageName = getReadablePackageName(packageType);
            
            showNotification(`${packageName} added to your selections`);
        });
    });
}

/**
 * Show notification when adding packages
 */
function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = 'var(--teal)';
    notification.style.color = 'white';
    notification.style.padding = '1rem 2rem';
    notification.style.borderRadius = '6px';
    notification.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
    notification.style.zIndex = '9999';
    notification.style.opacity = '1';
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(function() {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s ease';
        setTimeout(function() {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

/**
 * Get readable package name
 */
function getReadablePackageName(packageType) {
    const packageMap = {
        'bug-hunter': 'Bug Hunter Package',
        'user-journey': 'User Journey Package',
        'system-auditor': 'System Auditor Package',
        'precision-strike': 'Precision Strike Package',
        'automation': 'Automation Package',
        'automation-rapid': 'Rapid Smoke Test Automation',
        'automation-core': 'Core Workflow Automation',
        'automation-enterprise': 'Enterprise Automation Solution',
        'bug-verification': 'Bug Verification Add-on',
        'monthly-checkin': 'Monthly Check-In Add-on',
        'automation-maintenance': 'Quarterly Maintenance Add-on',
        'automation-edge-case': 'Edge Case Testing Add-on',
        'blocked-hours': 'Hourly Package',
        'prepaid-hours': '10+ Hour Package'
    };
    
    return packageMap[packageType] || 'Package';
}

/**
 * Check if a package is an add-on
 */
function isAddonPackage(packageType) {
    const addonPackages = [
        'bug-verification',
        'monthly-checkin',
        'automation-maintenance',
        'automation-edge-case'
    ];
    
    return addonPackages.includes(packageType);
}

/**
 * Handle URL parameters for package selection
 */
function handleUrlParameters() {
    // Check if we're on the contact page
    if (document.getElementById('contactForm')) {
        const urlParams = new URLSearchParams(window.location.search);
        const packageToSelect = urlParams.get('package');
        const isAddOperation = urlParams.get('add') === 'true';
        
        if (packageToSelect && isAddOperation) {
            // For standard packages (checkboxes)
            const checkbox = document.getElementById(packageToSelect);
            if (checkbox) {
                checkbox.checked = true;
                highlightElement(checkbox.parentNode);
            }
            
            // For non-addon packages, also select the standard package radio button
            if (!isAddonPackage(packageToSelect)) {
                // Standard package selection
                const standardPackageRadio = document.getElementById('standard-package');
                if (standardPackageRadio) {
                    standardPackageRadio.checked = true;
                }
            }
            
            // Handle special cases for service types
            if (packageToSelect === 'blocked-hours' || packageToSelect === 'precision-strike') {
                // Precision Strike maps to Blocked Hours
                const radioButton = document.getElementById('blocked-hours');
                if (radioButton) {
                    radioButton.checked = true;
                    
                    // Show the hours input
                    const hoursInput = document.getElementById('hours-needed');
                    if (hoursInput) {
                        hoursInput.style.display = 'block';
                    }
                    
                    highlightElement(radioButton.parentNode);
                }
            } else if (packageToSelect === 'prepaid-hours') {
                const radioButton = document.getElementById('prepaid-hours');
                if (radioButton) {
                    radioButton.checked = true;
                    
                    // Show the prepaid hours selector
                    const prepaidHoursSelector = document.getElementById('prepaid-hours-selector');
                    if (prepaidHoursSelector) {
                        prepaidHoursSelector.style.display = 'block';
                    }
                    
                    highlightElement(radioButton.parentNode);
                }
            }
            
            // Scroll to the form section
            const contactSection = document.getElementById('contact');
            if (contactSection) {
                setTimeout(() => {
                    contactSection.scrollIntoView({ behavior: 'smooth' });
                }, 500);
            }
        }
    }
}

/**
 * Highlight an element briefly
 */
function highlightElement(element) {
    if (element) {
        element.classList.add('highlighted');
        setTimeout(() => {
            element.classList.remove('highlighted');
        }, 3000);
    }
}

/**
 * Initialize prepaid hours selector
 */
function initPrepaidHoursSelector() {
    const hourBlocksInput = document.getElementById('hour-blocks');
    const totalHoursDisplay = document.getElementById('total-hours');
    
    if (hourBlocksInput && totalHoursDisplay) {
        hourBlocksInput.addEventListener('input', function() {
            // Ensure the value is at least 1
            if (this.value < 1) this.value = 1;
            
            // Calculate and display total hours
            const blocks = parseInt(this.value) || 1;
            totalHoursDisplay.textContent = blocks * 10;
        });
    }
}

/**
 * Initialize service type radios
 */
function initServiceTypeRadios() {
    const serviceTypeRadios = document.querySelectorAll('input[name="service-type"]');
    const hoursInput = document.getElementById('hours-needed');
    const prepaidSelector = document.getElementById('prepaid-hours-selector');
    
    if (serviceTypeRadios.length > 0) {
        serviceTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide both inputs first
                if (hoursInput) hoursInput.style.display = 'none';
                if (prepaidSelector) prepaidSelector.style.display = 'none';
                
                // Show the appropriate input based on selection
                if (this.value === 'blocked-hours' && hoursInput) {
                    hoursInput.style.display = 'block';
                } else if (this.value === 'prepaid-hours' && prepaidSelector) {
                    prepaidSelector.style.display = 'block';
                }
            });
        });
    }
    
    // Initialize display state for existing selections
    if (document.getElementById('blocked-hours') && document.getElementById('blocked-hours').checked && hoursInput) {
        hoursInput.style.display = 'block';
    } else if (document.getElementById('prepaid-hours') && document.getElementById('prepaid-hours').checked && prepaidSelector) {
        prepaidSelector.style.display = 'block';
    }
}

/**
 * Initialize FAQ accordions
 */
function initFaqAccordions() {
    const faqItems = document.querySelectorAll('.faq-item');
    
    faqItems.forEach(item => {
        const question = item.querySelector('.faq-question');
        
        if (question) {
            question.addEventListener('click', function() {
                // Close all other FAQs
                faqItems.forEach(otherItem => {
                    if (otherItem !== item && otherItem.classList.contains('active')) {
                        otherItem.classList.remove('active');
                    }
                });
                
                // Toggle this FAQ
                item.classList.toggle('active');
            });
        }
    });
}

/**
 * Initialize custom cursor
 */
function initCustomCursor() {
    const cursor = document.querySelector('.cursor-follower');
    
    if (cursor && window.matchMedia('(hover: hover)').matches) {
        // Set up cursor movement
        document.addEventListener('mousemove', function(e) {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
            
            if (!cursor.classList.contains('active')) {
                setTimeout(() => {
                    cursor.classList.add('active');
                }, 300);
            }
        });
        
        // Add hover effects for links and buttons
        const links = document.querySelectorAll('a, button');
        links.forEach(link => {
            link.addEventListener('mouseenter', () => {
                if (link.classList.contains('cta-button')) {
                    cursor.classList.add('hover-button');
                } else {
                    cursor.classList.add('hover-link');
                }
            });
            
            link.addEventListener('mouseleave', () => {
                cursor.classList.remove('hover-link', 'hover-button');
            });
        });
        
        // Hide cursor when it leaves the window
        document.addEventListener('mouseleave', () => {
            cursor.classList.remove('active');
        });
        
        document.addEventListener('mouseenter', () => {
            cursor.classList.add('active');
        });
    } else if (cursor) {
        // If not a hover device, hide the cursor completely
        cursor.style.display = 'none';
    }
}

// Initialize floating button visibility
document.addEventListener('DOMContentLoaded', function() {
    const floatingButton = document.getElementById('floating-add-button');
    if (floatingButton) {
        // Show the button after a delay
        setTimeout(function() {
            floatingButton.style.right = '0';
        }, 1500);
        
        // Add hover effect
        floatingButton.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(-10px)';
        });
        
        floatingButton.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    }
});
